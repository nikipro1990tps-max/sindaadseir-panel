name: Deploy Panel

on:
  push:
    branches: [ main, master ]

env:
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
  VPS_PORT: ${{ secrets.VPS_PORT }}
  VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
  VPS_GIT_TOKEN: ${{ secrets.VPS_GIT_TOKEN }}
  REPO_USERNAME: ${{ secrets.REPO_USERNAME }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.VPS_HOST }}
        username: ${{ env.VPS_USERNAME }}
        key: ${{ env.VPS_SSH_KEY }}
        port: ${{ env.VPS_PORT }}
        script: |
          set -e
          echo "Deploying Panel..."
          
          # Add repository to safe directory list to avoid ownership issues
          git config --global --add safe.directory /var/www/panel/sindaadseir-panel
          
          cd /var/www/panel/sindaadseir-panel
          
          # Configure git to use Personal Access Token for authentication
          # Use GitHub username with PAT token
          git config --global credential.helper store
          echo "https://${{ env.REPO_USERNAME }}:${{ env.VPS_GIT_TOKEN }}@github.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials
          
          # Update remote URL to use HTTPS (credentials will be read from .git-credentials)
          git remote set-url origin https://github.com/${{ github.repository }}.git
          
          # Discard any local changes to ensure clean deployment
          git reset --hard HEAD || true
          git clean -fd || true
          
          # Fetch latest changes and reset to match remote exactly
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          git clean -fd
          
          npm i
          npm run build
          sudo systemctl reload nginx
          
          echo "Panel deployed successfully!"
